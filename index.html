<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo List PWA</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#4f46e5">
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" type="image/png" href="/icon.png">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
    <div class="container mx-auto p-4 max-w-md">
        <h1 class="text-3xl font-bold text-center text-indigo-600 mb-6">Todo List</h1>
        <div id="errorMessage" class="hidden bg-red-100 text-red-700 p-2 rounded-md mb-4"></div>
        <div class="mb-4">
            <input id="todoInput" type="text" placeholder="Add a new task" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500">
            <button id="addTodo" class="mt-2 w-full bg-indigo-600 text-white p-2 rounded-md hover:bg-indigo-700">Add Task</button>
        </div>
        <div id="offlineMessage" class="hidden bg-yellow-100 text-yellow-700 p-2 rounded-md mb-4">You are offline. Some features may be limited.</div>
        <ul id="todoList" class="space-y-2"></ul>
        <button id="subscribePush" class="mt-4 w-full bg-blue-600 text-white p-2 rounded-md hover:bg-blue-700">Enable Notifications</button>
    </div>

    <script>
        // Service Worker Registration
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/service-worker.js');
                    console.log('Service Worker registered');
                    setupPushNotifications(registration);
                } catch (err) {
                    showError('Service Worker registration failed: ' + err.message);
                }
            });
        } else {
            showError('Service Workers are not supported in this browser.');
        }

        // Check online status
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);

        function updateOnlineStatus() {
            const offlineMessage = document.getElementById('offlineMessage');
            offlineMessage.classList.toggle('hidden', navigator.onLine);
        }

        // Error handling
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
            setTimeout(() => errorMessage.classList.add('hidden'), 5000);
        }

        // Todo List Logic
        const todoInput = document.getElementById('todoInput');
        const addTodoButton = document.getElementById('addTodo');
        const todoList = document.getElementById('todoList');

        // Load todos from localStorage with fallback
        let todos = [];
        try {
            todos = JSON.parse(localStorage.getItem('todos')) || [];
        } catch (e) {
            showError('Failed to load todos. Using empty list.');
        }

        // Render todos
        function renderTodos() {
            try {
                todoList.innerHTML = '';
                todos.forEach((todo, index) => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-2 bg-white rounded-md shadow';
                    li.innerHTML = `
                        <span class="${todo.completed ? 'line-through text-gray-500' : ''}">${todo.text}</span>
                        <div>
                            <button onclick="toggleTodo(${index})" class="text-green-600 mr-2">${todo.completed ? 'Undo' : 'Complete'}</button>
                            <button onclick="deleteTodo(${index})" class="text-red-600">Delete</button>
                        </div>
                    `;
                    todoList.appendChild(li);
                });
                saveTodos();
            } catch (e) {
                showError('Error rendering todos: ' + e.message);
            }
        }

        // Add new todo
        addTodoButton.addEventListener('click', () => {
            const text = todoInput.value.trim();
            if (!text) {
                showError('Please enter a task.');
                return;
            }
            try {
                todos.push({ text, completed: false });
                todoInput.value = '';
                renderTodos();
                if (Notification.permission === 'granted') {
                    showNotification('New Task Added', `Task "${text}" was added to your list.`);
                }
            } catch (e) {
                showError('Error adding todo: ' + e.message);
            }
        });

        // Toggle todo completion
        window.toggleTodo = (index) => {
            try {
                todos[index].completed = !todos[index].completed;
                renderTodos();
            } catch (e) {
                showError('Error toggling todo: ' + e.message);
            }
        };

        // Delete todo
        window.deleteTodo = (index) => {
            try {
                todos.splice(index, 1);
                renderTodos();
            } catch (e) {
                showError('Error deleting todo: ' + e.message);
            }
        };

        // Save todos to localStorage with error handling
        function saveTodos() {
            try {
                localStorage.setItem('todos', JSON.stringify(todos));
            } catch (e) {
                showError('Failed to save todos: ' + e.message);
            }
        }

        // Push Notifications Setup
        async function setupPushNotifications(registration) {
            const subscribeButton = document.getElementById('subscribePush');
            subscribeButton.addEventListener('click', async () => {
                try {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        const subscription = await registration.pushManager.subscribe({
                            userVisibleOnly: true,
                            applicationServerKey: 'YOUR_PUBLIC_VAPID_KEY' // Replace with your VAPID key
                        });
                        console.log('Push subscription successful:', subscription);
                        showNotification('Notifications Enabled', 'You will now receive todo updates.');
                        subscribeButton.classList.add('hidden');
                    } else {
                        showError('Notification permission denied.');
                    }
                } catch (e) {
                    showError('Error setting up notifications: ' + e.message);
                }
            });
        }

        // Show notification
        function showNotification(title, body) {
            if (Notification.permission === 'granted') {
                new Notification(title, { body, icon: '/icon.png' });
            }
        }

        // Initial render
        renderTodos();
        updateOnlineStatus();

        // Handle Enter key
        todoInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                addTodoButton.click();
            }
        });
    </script>
</body>
</html>
